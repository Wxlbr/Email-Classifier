<!doctype html>
<html lang="en">

<!-- Sortable library  for drag-and-drop animation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

<!-- TODO: Allow the user to change the network name (networkId) -->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/layout.css">
    <title>This totally works</title>
    <link rel="icon" href="/static/favicon.ico" type="image/x-icon" sizes="16x16">
</head>

<script>
    let layers = {};

    let inputSize = 0;
    let outputSize = 0;

    var flaskData = JSON.parse('{{ data | tojson }}');

    console.log(flaskData);

    networkId = flaskData.networkId;

    if (flaskData.layers) {
        layers = flaskData.layers;
    }

    if (flaskData.inputSize) {
        inputSize = flaskData.inputSize;
    }

    if (flaskData.outputSize) {
        outputSize = flaskData.outputSize;
    }

    console.log(layers, inputSize, outputSize)

</script>

<body>
    <div class="sidebar-grid full-view bg-grey-900">

        <!-- Sidebar -->
        <div class="border-right bg-grey-800">
            <div class="flex-col gap-2">

                <!-- Back Button -->
                <div class="h-15 items-center border-bottom padx-6 button-text">
                    <a class="items-center gap-2" onclick="redirectIndex()">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="m12 19-7-7 7-7"></path>
                            <path d="M19 12H5"></path>
                        </svg>
                        <span>Back to Network Menu</span>
                    </a>
                </div>

                <!-- Network Configuration Title -->
                <div class="h-15 items-center border-bottom padx-6 button-text">
                    <a class="items-center gap-2" href="#">
                        <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="16 18 22 12 16 6"></polyline>
                            <polyline points="8 6 2 12 8 18"></polyline>
                        </svg>
                        <span>NeuralNet Config</span>
                    </a>
                </div>

                <!-- Network Layer Overview -->
                <div class="pady-2 padx-4">
                    <nav class="grid text-sm gap-2">
                        <div id="inputLayer"
                            class="navMargin flex items-center gap-3 rounded bg-grey-700 padx-3 pady-2 text-grey transition-all hover:text-white cursor-move"
                            onclick="selectLayer('inputLayer')">

                            <!-- Layer Name -->
                            Input Layer
                        </div>
                    </nav>
                    <nav class="grid text-sm gap-2" id="layersView"></nav>
                    <nav class="grid text-sm gap-2">
                        <div id="outputLayer"
                            class="navMargin flex items-center gap-3 rounded bg-grey-700 padx-3 pady-2 text-grey transition-all hover:text-white cursor-move"
                            onclick="selectLayer('outputLayer')">

                            <!-- Layer Name -->
                            Output Layer
                        </div>
                    </nav>

                    <script>

                        // Enable Sortable.js
                        const layersView = document.getElementById("layersView");

                        // Initialize Sortable on the layersView container
                        const sortable = new Sortable(layersView, {
                            animation: 150,
                            handle: ".handle",
                            onUpdate: (evt) => updateLayerOrder(evt),
                        });

                        function clearNetworkSidebar() {
                            const layersView = document.getElementById("layersView");
                            layersView.innerHTML = "";
                        }

                        function loadNetwork(layers) {
                            // Clear network sidebar
                            clearNetworkSidebar();

                            const layersView = document.getElementById("layersView");

                            for (const layerId in layers) {
                                const layerName = layers[layerId]["layerName"];

                                layersView.innerHTML += `<div aria-grabbed="false" id="${layerId}"
                                class="navMargin flex items-center gap-3 rounded bg-grey-700 padx-3 pady-2 text-grey transition-all hover:text-white cursor-move"
                                onclick="selectLayer('${layerId}')">

                                <!-- Drag and Drop Layer Icon -->
                                <svg class="handle h-4 w-4 text-grey" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="4" x2="20" y1="12" y2="12"></line>
                                    <line x1="4" x2="20" y1="6" y2="6"></line>
                                    <line x1="4" x2="20" y1="18" y2="18"></line>
                                </svg>

                                <!-- Layer Name -->
                                ${layerName}

                                <!-- Layer Status -->
                                <span class="ml-auto bg-green-500 text-dark-grey padx-2 pady-1 rounded-full text-xs"
                                    id="validationStatus">Valid</span>
                            </div>`;
                            }

                            // Validate layers
                            validateLayers();

                            // Save network
                            saveNetwork();
                        }

                        function addLayer(layerId, layerName, layerType) {
                            layers[layerId] = {
                                "layerName": layerName,
                                "layerType": layerType,
                                "layerConfig": {
                                    // Default layer configuration values
                                    "inputSize": 0,
                                    "outputSize": 0,
                                    "activation": "sigmoid",
                                    "type": layerType
                                },
                                "valid": false,
                                "errors": []
                            };

                            // Load layer configuration
                            loadNetwork(layers);
                        }

                        function selectLayer(layerId) {
                            console.log("Selected layer: " + layerId);

                            loadLayerConfiguration(layerId);

                            // Change selected layer text colour
                            for (const layer of document.getElementById("layersView").children) {
                                if (layer.id == layerId) {
                                    layer.classList.remove("text-grey");
                                    layer.classList.add("text-white");
                                } else {
                                    layer.classList.remove("text-white");
                                    layer.classList.add("text-grey");
                                }
                            }
                        }

                        function validateLayers() {

                            for (const layerId in layers) {
                                const idNum = parseInt(layerId.split("-")[1]);
                                layers[layerId]["valid"] = true;
                                layers[layerId]["errors"] = [];


                                // Check inputSize
                                if (layers[layerId]["layerConfig"]["inputSize"] <= 0) {
                                    layers[layerId]["valid"] = false;
                                    layers[layerId]["errors"].push("Input size must be a positive integer");
                                }

                                if (idNum == 1) {
                                    // First layer
                                    if (layers[layerId]["layerConfig"]["inputSize"] != inputSize) {
                                        layers[layerId]["valid"] = false;
                                        layers[layerId]["errors"].push("Input size must match network input size of " + inputSize);
                                    }
                                } else {
                                    // Previous layer exists
                                    if (layers[layerId]["layerConfig"]["inputSize"] != layers["layer-" + (idNum - 1)][
                                        "layerConfig"]["outputSize"]) {
                                        layers[layerId]["valid"] = false;
                                        layers[layerId]["errors"].push("Input size must match previous layer's output size of " +
                                            layers["layer-" + (idNum - 1)]["layerConfig"]["outputSize"]);
                                    }
                                }

                                // Check outputSize
                                if (layers[layerId]["layerConfig"]["outputSize"] <= 0) {
                                    layers[layerId]["valid"] = false;
                                    layers[layerId]["errors"].push("Output size must be a positive integer");
                                }

                                if ("layer-" + (idNum + 1) in layers) {
                                    // Next layer exists
                                    if (layers[layerId]["layerConfig"]["outputSize"] != layers["layer-" + (idNum + 1)][
                                        "layerConfig"]["inputSize"]) {
                                        layers[layerId]["valid"] = false;
                                        layers[layerId]["errors"].push("Output size must match next layer's input size of " +
                                            layers["layer-" + (idNum + 1)]["layerConfig"]["inputSize"]);
                                    }
                                } else {
                                    // Next layer does not exist, must be the last layer
                                    if (layers[layerId]["layerConfig"]["outputSize"] != outputSize) {
                                        layers[layerId]["valid"] = false;
                                        layers[layerId]["errors"].push("Output size must match network output size of " + outputSize);
                                    }
                                }

                                // Update validation status
                                const layer = document.getElementById(layerId);
                                let validationStatus = layer.querySelector("#validationStatus");

                                if (layers[layerId]["valid"]) {
                                    validationStatus.innerHTML = "Valid";
                                    validationStatus.classList.remove("bg-red-500");
                                    validationStatus.classList.add("bg-green-500");
                                } else {
                                    validationStatus.innerHTML = "Invalid";
                                    validationStatus.classList.remove("bg-green-500");
                                    validationStatus.classList.add("bg-red-500");
                                }
                            }
                        }

                        function updateLayerOrder(event) {

                            // Move layer in layers object
                            const oldIndex = event.oldIndex + 1;
                            const newIndex = event.newIndex + 1;

                            const oldLayerId = "layer-" + oldIndex;
                            const newLayerId = "layer-" + newIndex;

                            const layer = layers[oldLayerId];
                            delete layers[oldLayerId];

                            // Rename keys to be sequential
                            let count = 1;
                            const newLayers = {};
                            for (const id in layers) {
                                if (('layer-' + count) == newLayerId) {
                                    newLayers['layer-' + count++] = layer;
                                    newLayers['layer-' + count++] = layers[id];
                                } else {
                                    newLayers['layer-' + count++] = layers[id];
                                }
                            }

                            if (!(newLayerId in newLayers)) {
                                newLayers[newLayerId] = layer;
                            }

                            layers = newLayers;

                            console.log(layers);

                            // Reload network sidebar
                            loadNetwork(layers);

                            console.log(layers);
                        }

                    </script>
                </div>

                <!-- Add Layer Button -->
                <div class="padx-4">
                    <button class="button button-blue w-full bg-blue-500" type="button"
                        onclick="togglePopup('newLayerPopup')">
                        Add a new layer
                    </button>
                </div>

                <div id="newLayerPopup" class="popup" style="display: none;">
                    <div class="popup-content card pad-4 flex-col items-center">
                        <h1 class="subtitle mb-4">
                            Pop-up Window</h1>
                        <div class="flex-col items-center w-full">
                            <button class="layer-button" onclick="selectLayerType('Dense Layer', 'dense')"
                                id="newLayerSelection-dense">Dense
                                Layer</button>
                            <hr class="button-divider">
                            <button class="layer-button" onclick="selectLayerType('Recurrent Layer', 'recurrent')"
                                id="newLayerSelection-recurrent">Recurrent Layer</button>
                        </div>
                        <div class="flex justify-between mt-4">
                            <button class="button button-green mr-2" type="submit" id="newLayerPopupAddButton" disabled>
                                Add
                            </button>
                            <button class="button button-red bg-red-500" type="submit"
                                onclick="togglePopup('newLayerPopup')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>

                <script>
                    function togglePopup(elementId) {
                        const popup = document.getElementById(elementId);
                        if (popup.style.display === "none") {
                            // Reset the popup
                            popup.style.display = "block";

                            // Disable the add button
                            document.getElementById("newLayerPopupAddButton").disabled = true;
                        } else {
                            popup.style.display = "none";

                            // Remove any selected buttons
                            for (const button of document.getElementsByClassName("layer-button")) {
                                button.classList.remove("selected");
                            }
                        }
                    }

                    function selectLayerType(layerName, layerType) {
                        // Change the colour of the selected button
                        const layerButton = document.getElementById("newLayerSelection-" + layerType);
                        layerButton.classList.add("selected");

                        // Change the colour of the other buttons
                        for (const button of document.getElementsByClassName("layer-button")) {
                            if (button.id != layerButton.id) {
                                button.classList.remove("selected");
                            }
                        }

                        // Determine the layerId
                        const layerId = "layer-" + (Object.keys(layers).length + 1);

                        // Change the onclick function of the add button to add the selected layer type
                        const addButton = document.getElementById("newLayerPopupAddButton");
                        addButton.onclick = function () {
                            // Close and reset the popup
                            togglePopup("newLayerPopup");

                            // Add the layer
                            addLayer(layerId, layerName, layerType);
                        };

                        // Activate the add button
                        addButton.disabled = false;
                    }
                </script>

            </div>
        </div>

        <!-- Layer Configuration Window -->
        <div class="flex-col gap-8 pad-6 text-grey">

            <!-- Layer Configuration Title -->
            <div class="flex items-center">
                <h1 class="subtitle" id="layerConfigurationTitle">
                    Layer Configuration
                </h1>
            </div>

            <!-- Layer Configuration Options Subwindow -->
            <div class="card bg-grey-800 border-grey">
                <div class="pad-4" id="layerConfigurationOptionsWindow" hidden>

                    <!-- Error Message -->
                    <div class="border border-red mb-4 rounded bg-red-500" id="ConfigurationErrorBox">
                        <p class="text-white p-4" id="ConfigurationErrorBoxHeader">
                        </p>
                        <ul style="list-style-type: disc; margin-top:-30px;" class="text-white p-4 pl-8"
                            id="ConfigurationErrorBoxList">
                        </ul>
                    </div>

                    <!-- Interactable Layer Option -->
                    <form>
                        <!-- Input Size-->
                        <div class="mb-4" id="inputSizeInputContainer">
                            <label class="text-sm text-grey">
                                Input Size
                            </label>
                            <input type="number" class="button border bg-grey-700 text-gray-300 w-full" id="inputSize">
                        </div>

                        <!-- Output Size -->
                        <div class="mb-4" id="outputSizeInputContainer">
                            <label class="text-sm text-grey">
                                Output Size
                            </label>
                            <input type="number" class="button border bg-grey-700 text-gray-300 w-full" id="outputSize">
                        </div>

                        <!-- Activation Selection -->
                        <div class="mb-4" id="activationInputContainer">
                            <label class="text-sm text-grey">Activation Function</label>
                            <div>
                                <select class="button border bg-grey-700 text-gray-300 w-full" id="activation">
                                    <option value="sigmoid">Sigmoid</option>
                                    <option value="tanh">Tanh</option>
                                </select>
                            </div>
                        </div>

                        <!-- Save Layer Configuration -->
                        <button class="button button-green bg-green-500 mr-4" type="submit"
                            onclick="saveLayerConfiguration('')" id="saveLayerConfigurationButton">
                            Save
                        </button>

                        <script>
                            function saveLayerConfiguration(layerId) {
                                event.preventDefault();

                                if (layerId == "inputLayer") {
                                    inputSize = document.getElementById("inputSize").value;
                                    validateLayers();
                                    saveNetwork();
                                    return;
                                }

                                if (layerId == "outputLayer") {
                                    outputSize = document.getElementById("outputSize").value;
                                    validateLayers();
                                    saveNetwork();
                                    return;
                                }

                                if (!(layerId in layers)) {
                                    console.log("Layer does not exist!");
                                    return;
                                }

                                // Get Layer Configuration Values
                                layers[layerId]["layerConfig"] = {
                                    "inputSize": document.getElementById("inputSize").value,
                                    "outputSize": document.getElementById("outputSize").value,
                                    "activation": document.getElementById("activation").value,
                                    "type": layers[layerId]["layerType"]
                                };

                                validateLayers();

                                // Change Error Box
                                if (layers[layerId]["valid"]) {
                                    document.getElementById("ConfigurationErrorBox").style.display = "none";
                                } else {
                                    document.getElementById("ConfigurationErrorBox").style.display = "block";
                                    document.getElementById("ConfigurationErrorBoxHeader").innerHTML = "Invalid Layer Configuration";
                                    document.getElementById("ConfigurationErrorBoxList").innerHTML = "";

                                    for (const error of layers[layerId]["errors"]) {
                                        document.getElementById("ConfigurationErrorBoxList").innerHTML += "<li>" + error +
                                            "</li>";
                                    }
                                }

                                console.log(layers);

                                saveNetwork();
                            }

                            function resolvePlaceholder(remove = true) {

                                if (remove) {
                                    // Hide Placeholder
                                    document.getElementById("layerConfigurationPlaceholder").style.display = "none";
                                    document.getElementById("layerConfigurationOptionsWindow").hidden = false;
                                } else {
                                    // Show Placeholder
                                    document.getElementById("layerConfigurationTitle").innerHTML =
                                        "Layer Configuration";
                                    document.getElementById("layerConfigurationPlaceholder").style.display = "flex";
                                    document.getElementById("layerConfigurationOptionsWindow").hidden = true;
                                }
                            }

                            function loadLayerConfiguration(layerId) {

                                resolvePlaceholder();

                                if (!(layerId in layers) && layerId != "inputLayer" && layerId != "outputLayer") {
                                    console.log("Layer does not exist!");
                                    return;
                                }

                                // Load Layer Configuration
                                if (layerId == "inputLayer") {

                                    // Input Layer Title 
                                    document.getElementById("layerConfigurationTitle").innerHTML = "Input Layer Configuration"

                                    // Configuration Values
                                    document.getElementById("inputSize").value = inputSize;

                                    // Show respective inputs
                                    document.getElementById("inputSizeInputContainer").hidden = false;
                                    document.getElementById("outputSizeInputContainer").hidden = true;
                                    document.getElementById("activationInputContainer").hidden = true;

                                    // Hide Error Box
                                    document.getElementById("ConfigurationErrorBox").style.display = "none";

                                    // Hide Delete Layer Button
                                    document.getElementById("deleteLayerConfigurationButton").style.display = "none";

                                } else if (layerId == "outputLayer") {

                                    // Output Layer Title
                                    document.getElementById("layerConfigurationTitle").innerHTML = "Output Layer Configuration"

                                    // Configuration Values
                                    document.getElementById("outputSize").value = outputSize;

                                    // Show respective inputs
                                    document.getElementById("inputSizeInputContainer").hidden = true;
                                    document.getElementById("outputSizeInputContainer").hidden = false;
                                    document.getElementById("activationInputContainer").hidden = true;

                                    // Hide Error Box
                                    document.getElementById("ConfigurationErrorBox").style.display = "none";

                                    // Hide Delete Layer Button
                                    document.getElementById("deleteLayerConfigurationButton").style.display = "none";

                                } else {

                                    // Layer Title
                                    document.getElementById("layerConfigurationTitle").innerHTML = layers[layerId][
                                        "layerName"
                                    ] + " Configuration";

                                    // Configuration Values
                                    document.getElementById("inputSize").value = layers[layerId]["layerConfig"][
                                        "inputSize"];
                                    document.getElementById("outputSize").value = layers[layerId]["layerConfig"][
                                        "outputSize"];
                                    document.getElementById("activation").value = layers[layerId]["layerConfig"][
                                        "activation"];

                                    // Show respective inputs
                                    document.getElementById("inputSizeInputContainer").hidden = false;
                                    document.getElementById("outputSizeInputContainer").hidden = false;
                                    document.getElementById("activationInputContainer").hidden = false;

                                    // Change Error Box
                                    if (layers[layerId]["valid"]) {
                                        document.getElementById("ConfigurationErrorBox").style.display = "none";
                                    } else {
                                        document.getElementById("ConfigurationErrorBox").style.display = "block";
                                        document.getElementById("ConfigurationErrorBoxHeader").innerHTML = "Invalid Layer Configuration";
                                        document.getElementById("ConfigurationErrorBoxList").innerHTML = "";

                                        for (const error of layers[layerId]["errors"]) {
                                            document.getElementById("ConfigurationErrorBoxList").innerHTML += "<li>" + error +
                                                "</li>";
                                        }
                                    }
                                }

                                // Change Button onclick functions
                                document.getElementById("saveLayerConfigurationButton").onclick = function () {
                                    saveLayerConfiguration(layerId);
                                };
                                document.getElementById("deleteLayerConfigurationButton").onclick = function () {
                                    deleteLayer(layerId);
                                };

                            }

                        </script>

                        <!-- Delete Layer -->
                        <button class="button button-red bg-red-500" type="submit" onclick="deleteLayer()"
                            id="deleteLayerConfigurationButton">
                            Delete Layer
                        </button>

                        <script>

                            function deleteLayer(layerId) {

                                event.preventDefault();

                                // Rename layers and keys to be sequential
                                let count = 1;
                                const newLayers = {};
                                for (const id in layers) {
                                    const newId = 'layer-' + count;
                                    if (id != layerId) {
                                        newLayers[newId] = layers[id];
                                        count++;
                                    }
                                }

                                layers = newLayers;

                                // Reload network sidebar
                                loadNetwork(layers);

                                resolvePlaceholder(remove = false);
                            }

                        </script>
                    </form>
                </div>

                <!-- Layer Configuration Placeholder -->
                <div class="justify-flex h-96" id="layerConfigurationPlaceholder">
                    <p class="text text-grey pad-4">
                        Select a layer to configure it
                    </p>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Load new network configuration
        loadNetwork(layers);

        function saveNetwork() {
            fetch('/save-network', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 'networkId': networkId, 'layers': layers, 'inputSize': inputSize, 'outputSize': outputSize }),
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log('Success:', data);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        function redirectIndex() {
            window.location.href = "/";
        }

    </script>

</html>